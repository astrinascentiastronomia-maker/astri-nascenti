<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ASTRI NASCENTI — Book</title>
<style>
  html,body{margin:0;height:100%;background:#0b0b0b;color:#fff;font-family:system-ui,Arial;overflow:hidden}
  .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;box-sizing:border-box}
  .book{width:min(92vw,520px);aspect-ratio:13/18;position:relative;perspective:1800px}
  .viewport{width:100%;height:100%;position:relative;overflow:hidden;background:#111;border-radius:8px;box-shadow:0 30px 80px rgba(0,0,0,.8);touch-action:pan-y}
  .layer{position:absolute;inset:0;backface-visibility:hidden;transform-style:preserve-3d}
  .layer img{width:100%;height:100%;object-fit:cover;user-select:none;-webkit-user-drag:none;display:block}
  .next{z-index:1}
  .flipper{transform-origin:left center;transition:transform .85s cubic-bezier(.2,.9,.2,1);z-index:2}
  .flipper.turn{transform:rotateY(-180deg)}
  .flipper .back{position:absolute;inset:0;transform:rotateY(180deg);backface-visibility:hidden}
  .controls{margin-top:12px;display:flex;gap:12px;align-items:center;justify-content:center}
  button{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.25);color:#fff;padding:10px 16px;font-size:15px;border-radius:10px;cursor:pointer;transition:0.2s}
  button:hover{background:rgba(255,255,255,.18)}
  .status{font-size:14px;opacity:.9;min-width:60px;text-align:center}
  @media (hover:none) and (pointer:coarse){button{padding:14px 18px;font-size:17px}}
</style>
</head>
<body>

<div class="wrap">
  <div class="book">
    <div class="viewport" id="viewport">
      <div class="layer next"><img id="nextImg" alt="pagina sotto"></div>
      <div class="layer flipper" id="flipper">
        <img id="currentImg" alt="pagina corrente">
        <div class="back"><img id="backImg" alt="retro pagina"></div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="prev">◀ Indietro</button>
    <div class="status" id="status">1 / 36</div>
    <button id="next">Avanti ▶</button>
  </div>
</div>

<script>
/* CONFIGURAZIONE */
const TOTAL = 36;
const PATH = 'https://astrinascentiastronomia-maker.github.io/astri-nascenti/astri-nascenti/introduzione-astronomia/pag/astri-nascenti-2025-';
const EXT = '.jpg';

/* ELEMENTI */
const currentImg = document.getElementById('currentImg');
const nextImg = document.getElementById('nextImg');
const backImg = document.getElementById('backImg');
const flipper = document.getElementById('flipper');
const status = document.getElementById('status');
const viewport = document.getElementById('viewport');

let index = 1;
let busy = false;
let flipping = false;

/* URL HELPER */
const src = i => {
  const n = Math.max(1, Math.min(TOTAL, i));
  return `${PATH}${n}${EXT}`;
};

/* PRELOAD */
function preload(n){
  return new Promise(r=>{
    const img = new Image();
    img.onload = ()=>r(true);
    img.onerror = ()=>r(false);
    img.src = src(n);
  });
}

function renderImmediate(){
  currentImg.src = src(index);
  const nextIndex = Math.min(index + 1, TOTAL);
  backImg.src = src(nextIndex);
  nextImg.src = src(nextIndex);
  status.textContent = `${index} / ${TOTAL}`;
}

/* FLIP LOGIC */
function next(){
  if(busy || index >= TOTAL) return;
  busy = true;
  flipping = true;
  const target = index + 1;
  
  preload(target).then(()=>{
    backImg.src = src(target);
    nextImg.src = src(target);
    flipper.classList.add('turn');
  });
}

function prev(){
  if(busy || index <= 1) return;
  busy = true;
  index = Math.max(1, index - 1);
  renderImmediate();
  setTimeout(()=> busy = false, 150);
}

function onTransitionEnd(e){
  if(!flipping || e.propertyName !== 'transform') return;
  flipping = false;
  index = Math.min(index + 1, TOTAL);
  
  flipper.style.transition = 'none';
  flipper.classList.remove('turn');
  renderImmediate();
  
  void flipper.offsetWidth; // Trigger reflow
  requestAnimationFrame(()=> {
    flipper.style.transition = 'transform 0.85s cubic-bezier(.2,.9,.2,1)';
    busy = false;
  });
}

/* EVENTI */
document.getElementById('next').onclick = next;
document.getElementById('prev').onclick = prev;
flipper.addEventListener('transitionend', onTransitionEnd);

/* GESTIONE TOUCH & CLICK */
(function enableInteractions(){
  let startX=0, lastX=0, startTime=0, isDragging=false;
  
  viewport.addEventListener('touchstart', (e)=>{
    startX = lastX = e.touches[0].clientX;
    startTime = Date.now();
    isDragging = false;
  }, {passive:true});

  viewport.addEventListener('touchmove', (e)=>{
    const dx = e.touches[0].clientX - startX;
    if(Math.abs(dx) > 10) isDragging = true;
    lastX = e.touches[0].clientX;
  }, {passive:true});

  viewport.addEventListener('touchend', ()=>{
    const dx = lastX - startX;
    const dt = Date.now() - startTime;
    if(isDragging && Math.abs(dx) > 40){
      if(dx < 0) next(); else prev();
    } else if(dt < 300) {
      // Tap/Click semplice
      const rect = viewport.getBoundingClientRect();
      if((lastX - rect.left) > rect.width/2) next(); else prev();
    }
  });

  viewport.addEventListener('click', (e)=>{
    if(isDragging) return;
    const rect = viewport.getBoundingClientRect();
    if((e.clientX - rect.left) > rect.width/2) next(); else prev();
  });
})();

/* AVVIO */
renderImmediate();
</script>
</body>
</html>
